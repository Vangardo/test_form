<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Form Engine — Admin / User</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af;
    --brand:#6d28d9; --brand-2:#8b5cf6; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    --line:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0; background:linear-gradient(180deg,#0f172a,#0b1223); color:var(--ink); font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial;}
  h1,h2,h3{margin:.2rem 0 .6rem}
  h1{font-size:22px} h2{font-size:18px; color:#c7d2fe}
  .shell{max-width:1200px; margin:24px auto; padding:0 16px}
  .tabs{display:flex; gap:10px; margin-bottom:16px}
  .tab{padding:10px 14px; border:1px solid var(--line); background:#0b1223; border-radius:10px; cursor:pointer; color:var(--muted)}
  .tab.active{background:linear-gradient(180deg,#1e1b4b,#0b1223); color:#eef; border-color:#2a2f47}
  .grid{display:grid; gap:14px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .panel{background:linear-gradient(180deg,#111827,#0b1223); border:1px solid var(--line); padding:16px; border-radius:14px; box-shadow:0 0 0 1px rgba(255,255,255,.02) inset}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  label{display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted)}
  input[type="text"], input[type="number"], input[type="date"], textarea, select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #243041; background:#0a1220; color:var(--ink); outline:none;
  }
  textarea{min-height:80px; resize:vertical}
  input[type="checkbox"]{transform:scale(1.2)}
  .btn{padding:10px 14px; border-radius:10px; border:1px solid #39425c; background:linear-gradient(180deg,#1b2540,#111a33); color:#e9e9ff; cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .btn.primary{background:linear-gradient(180deg,var(--brand-2),var(--brand)); border-color:#5b21b6}
  .btn.ghost{background:#0a1220}
  .btn.ok{background:linear-gradient(180deg,#16a34a,#15803d); border-color:#14532d}
  .btn.warn{background:linear-gradient(180deg,#f59e0b,#b45309); border-color:#92400e}
  .btn.error{background:linear-gradient(180deg,#ef4444,#b91c1c); border-color:#7f1d1d}
  .muted{color:var(--muted)}
  .list{display:flex; flex-direction:column; gap:6px; max-height:200px; overflow:auto; padding-right:6px}
  .item{padding:8px 10px; border:1px dashed #2a2f47; border-radius:10px}
  .item.clickable{cursor:pointer; border-style:solid; border-color:#2a2f47; transition:background .2s,border-color .2s}
  .item.clickable:hover{border-color:#4338ca; background:rgba(67,56,202,.08)}
  .item.active{border-color:#6366f1; background:rgba(99,102,241,.12)}
  .k{color:#a5b4fc}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px}
  .divider{height:1px; background:#222a3f; margin:10px 0}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#1f2937; color:#d1d5db; border:1px solid #374151}
  .right{margin-left:auto}
  .hint{font-size:12px; color:#a1a1aa}
  .row.wrap{flex-wrap:wrap}
  .table{width:100%; border-collapse:collapse; font-size:14px}
  .table th,.table td{border-bottom:1px solid #1f2a3f; padding:8px 6px; text-align:left}
  .hr{height:1px;background:#1f2a3f;margin:16px 0}
  .code{white-space:pre-wrap; background:#0a1022; border:1px solid #1d2640; padding:10px; border-radius:10px}
  .badge{padding:2px 6px;border-radius:8px;background:#0c1429;border:1px solid #29344f;color:#c7d2fe;font-size:12px}
  .view{display:none}
  .toast-overlay{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;z-index:9999;max-width:320px}
  .toast-item{padding:10px 14px;border-radius:10px;background:rgba(30,41,59,.95);border:1px solid rgba(148,163,184,.45);font-size:14px;box-shadow:0 10px 30px rgba(15,23,42,.45);transition:opacity .4s ease,transform .4s ease}
  .toast-item.info{border-color:#6366f1;color:#e0e7ff}
  .toast-item.ok{border-color:#16a34a;color:#bbf7d0}
  .toast-item.warn{border-color:#f59e0b;color:#fde68a}
  .toast-item.err{border-color:#ef4444;color:#fecaca}
  .toast-item.hide{opacity:0;transform:translateY(-10px)}
  .admin-layout{display:grid;grid-template-columns:320px minmax(0,1fr);gap:16px}
  .stack{display:flex;flex-direction:column;gap:16px}
  .panel-header{display:flex;align-items:flex-start;gap:12px;justify-content:space-between;margin-bottom:12px}
  .panel-header h2{margin:0}
  .panel-body{display:flex;flex-direction:column;gap:16px}
  .segment{display:flex;flex-direction:column;gap:12px;padding:12px;border-radius:12px;background:rgba(15,23,42,.7);border:1px dashed #1f2937}
  .segment-title{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#c7d2fe}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .flow{display:grid;gap:12px}
  .flow.cols-2{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
  .flow-canvas{display:flex;flex-wrap:wrap;gap:12px;padding:12px;border-radius:12px;background:rgba(15,23,42,.6);border:1px dashed #273247;min-height:120px;position:relative}
  .flow-node{flex:1 1 220px;min-width:200px;max-width:260px;border-radius:12px;border:1px solid #2f3a55;background:linear-gradient(180deg,#111a32,#0b1223);padding:12px;cursor:grab;display:flex;flex-direction:column;gap:8px;position:relative}
  .flow-node.dragging{opacity:.6}
  .flow-node.drag-over{outline:2px dashed #6366f1;outline-offset:4px}
  .flow-node.active{border-color:#6366f1;box-shadow:0 0 0 1px rgba(99,102,241,.35)}
  .flow-node-header{display:flex;flex-direction:column;gap:2px}
  .flow-node-header strong{font-size:14px}
  .flow-node-meta{font-size:12px;color:var(--muted)}
  .flow-links{display:flex;flex-direction:column;gap:4px;font-size:12px}
  .flow-link{display:flex;align-items:center;gap:6px;color:#a5b4fc}
  .flow-link::before{content:'↠';color:#6366f1}
  .flow-node-actions{display:flex;gap:6px;flex-wrap:wrap}
  .btn.sm{padding:6px 10px;font-size:12px;border-radius:8px}
  .flow-empty{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px}
  .target-pill{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;border:1px solid #374151;background:#10172d;font-size:12px}
  .target-pill button{border:none;background:none;color:#f87171;cursor:pointer;font-size:12px}
  .hint-block{font-size:13px;line-height:1.5;color:#c7d2fe;background:rgba(76,29,149,.15);border:1px solid rgba(76,29,149,.35);border-radius:12px;padding:12px}
  .list-header{display:flex;align-items:center;justify-content:space-between;font-size:13px;color:var(--muted)}
  .pill-group{display:flex;flex-wrap:wrap;gap:6px}
  @media (max-width:1100px){.admin-layout{grid-template-columns:1fr}}
  @media (max-width:720px){.tabs{flex-wrap:wrap}}
</style>
</head>
<body>
<div id="toastOverlay" class="toast-overlay" aria-live="polite" aria-atomic="true"></div>
<div class="shell">
  <div class="tabs">
    <button class="tab active" data-tab="admin">Админ</button>
    <button class="tab" data-tab="user">Пользователь</button>
    <button class="tab" data-tab="archive">Анкеты</button>
    <span class="right muted">API: <span id="apiBase" class="pill mono">http://127.0.0.1:8000</span></span>
  </div>

  <!-- ADMIN -->
  <section id="admin" data-display="block" style="display:block">
    <div class="admin-layout">
      <aside class="stack">
        <div class="panel">
          <div class="panel-header">
            <h2>Формы</h2>
            <span class="badge">Контур</span>
          </div>
          <div class="panel-body">
            <div class="segment">
              <div class="segment-title">Новая форма</div>
              <div class="row">
                <label style="flex:1 1 160px">Код<input id="f_code" type="text" placeholder="loan_app" /></label>
                <label style="flex:1 1 240px">Название<input id="f_title" type="text" placeholder="Заявка на кредит" /></label>
              </div>
              <label>Описание<textarea id="f_desc" placeholder="Описание формы"></textarea></label>
              <div class="toolbar"><button class="btn primary" id="btnCreateForm">Создать форму</button></div>
            </div>
            <div class="segment">
              <div class="segment-title">Работа с текущей формой</div>
              <label>Текущая форма<select id="formsSelect"></select></label>
              <div class="hint">start_step устанавливается на первый добавленный шаг</div>
              <div id="formInfo" class="mono muted"></div>
              <div class="hint-block">Выберите форму, чтобы управлять шагами, полями и маршрутами. Все изменения сразу доступны в рантайме.</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h2>Маршрут шагов</h2>
            <span class="muted mono">Выберите и настройте шаг</span>
          </div>
          <div class="panel-body">
            <div class="segment">
              <div class="segment-title">Карточка шага</div>
              <div class="row">
                <label style="flex:1 1 160px">Код<input id="s_code" type="text" placeholder="personal" /></label>
                <label style="flex:1 1 200px">Название<input id="s_title" type="text" placeholder="Личные данные" /></label>
              </div>
              <div class="row">
                <label style="flex:1 1 160px">Тип шага<select id="s_type"></select></label>
                <label style="flex:1 1 120px">Порядок<input id="s_order" type="number" value="100" /></label>
              </div>
              <div class="row">
                <label style="flex:1 1 140px">Финальный?<input id="s_terminal" type="checkbox" /></label>
                <label style="flex:1 1 140px">Стартовый?<input id="s_start" type="checkbox" /></label>
              </div>
              <div class="toolbar">
                <button class="btn primary" id="btnCreateStep">Добавить шаг</button>
                <button class="btn ok" id="btnUpdateStep">Сохранить изменения</button>
                <button class="btn ghost" id="btnResetStep">Очистить</button>
                <button class="btn ghost" id="btnReloadSteps">Обновить список</button>
              </div>
            </div>
            <div class="segment">
              <div class="segment-title">Навигатор шагов</div>
              <div class="hint-block">Переключайтесь между шагами, чтобы сразу увидеть их поля, правила видимости и сценарии переходов.</div>
              <div id="stepsList" class="list"></div>
            </div>
          </div>
        </div>
      </aside>

      <main class="stack">
        <div class="panel">
          <div class="panel-header">
            <h2>Визуальный сценарий</h2>
            <span class="muted mono">Drag & Drop шагов и связей</span>
          </div>
          <div class="panel-body">
            <div class="hint-block">Перетаскивайте шаги, чтобы менять порядок, и быстро переходите к настройке переходов и правил видимости. Стрелки показывают, куда ведут сценарии.</div>
            <div id="flowCanvas" class="flow-canvas">
              <div class="flow-empty">Нет шагов в форме</div>
            </div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-header">
            <h2>Конструктор шага</h2>
            <span class="muted mono">Поля и условия видимости</span>
          </div>
          <div class="panel-body">
            <div class="hint-block">Соберите структуру шага, настройте обязательность, справочники и условия видимости. Видимость полей можно связать с любыми значениями на текущем или предыдущих шагах.</div>
            <div class="segment">
              <div class="segment-title">Добавление поля</div>
              <div class="row">
                <label style="flex:1 1 160px">Шаг<select id="fld_step"></select></label>
                <label style="flex:1 1 160px">Код<input id="fld_code" type="text" placeholder="first_name" /></label>
                <label style="flex:1 1 200px">Название<input id="fld_title" type="text" placeholder="Имя" /></label>
              </div>
              <div class="row">
                <label style="flex:1 1 160px">Data Type<select id="fld_dtype"></select></label>
                <label style="flex:1 1 160px">Input Type<select id="fld_input"></select></label>
                <label style="flex:1 1 140px">Required?<input id="fld_req" type="checkbox" /></label>
                <label style="flex:1 1 160px">Скрыть по умолчанию?<input id="fld_hidden" type="checkbox" /></label>
                <label style="flex:1 1 140px">Порядок<input id="fld_order" type="number" value="100" /></label>
              </div>
              <div id="fldDictRow" class="row" style="display:none">
                <label style="flex:1 1 240px">Справочник<select id="fld_dict"></select></label>
                <span class="hint">Или задайте локальные опции ниже</span>
              </div>
              <div id="fldOpts" class="list" style="display:none"></div>
              <div class="toolbar" id="fldOptsBtns" style="display:none">
                <button class="btn ghost" id="btnAddFldOpt">+ опция</button>
              </div>
              <div class="toolbar">
                <button class="btn primary" id="btnCreateField">Добавить поле</button>
                <button class="btn ok" id="btnUpdateField">Сохранить изменения</button>
                <button class="btn ghost" id="btnResetField">Очистить</button>
                <button class="btn ghost" id="btnReloadFields">Обновить</button>
              </div>
            </div>
            <div class="segment">
              <div class="list-header">
                <span>Поля шага</span>
              </div>
              <div id="fieldsList" class="list"></div>
            </div>
            <div class="segment">
              <div class="list-header">
                <span>Правила видимости</span>
              </div>
              <div class="hint">Настройте сценарии отображения уточняющих вопросов, зависящих от ответов пользователя.</div>
              <div id="visibilityList" class="list"></div>
            </div>
            <div class="segment">
              <div class="list-header">
                <span>Редактор правила</span>
                <span id="visEditState" class="muted">Создание нового правила</span>
              </div>
              <div class="row">
                <label style="flex:1 1 180px">Действие<select id="vis_action"></select></label>
                <label style="flex:1 1 140px">Приоритет<input type="number" id="vis_priority" value="100"></label>
                <label style="flex:1 1 140px">Логика<select id="vis_logic"><option>AND</option><option>OR</option></select></label>
              </div>
              <label>Описание<textarea id="vis_description" placeholder="Сценарий / подсказка"></textarea></label>
              <div class="segment-title">Целевые поля</div>
              <div class="row">
                <label style="flex:1 1 220px">Поле<select id="vis_target_select"></select></label>
                <button class="btn ghost sm" id="btnAddVisTarget" type="button">Добавить</button>
              </div>
              <div id="visTargets" class="pill-group"></div>
              <div class="divider"></div>
              <div class="list-header">
                <span>Условия</span>
              </div>
              <div id="visCondList" class="list"></div>
              <div class="toolbar">
                <button class="btn ghost sm" id="btnAddVisCond" type="button">+ условие</button>
                <span class="right"></span>
                <button class="btn ghost sm" id="btnResetVisibilityRule" type="button">Очистить</button>
                <button class="btn ok sm" id="btnUpdateVisibilityRule" type="button">Сохранить изменения</button>
                <button class="btn primary sm" id="btnCreateVisibilityRule" type="button">Создать правило</button>
              </div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h2>Сценарии переходов</h2>
            <span class="muted mono">Следующий шаг по условиям</span>
          </div>
          <div class="panel-body">
            <div class="hint-block">Свяжите шаги между собой: в зависимости от ответов на предыдущих шагах можно переходить на разные ветки сценария.</div>
            <div class="segment">
              <div class="segment-title">Настройка перехода</div>
              <div class="row">
                <label style="flex:1 1 200px">Источник<select id="tr_src"></select></label>
                <label style="flex:1 1 200px">Цель<select id="tr_dst"></select></label>
              </div>
              <div class="row">
                <label style="flex:1 1 140px">Приоритет<input type="number" id="tr_prio" value="100"/></label>
                <label style="flex:1 1 160px">Логика<select id="tr_logic"><option>AND</option><option>OR</option></select></label>
              </div>
            </div>
            <div class="segment">
              <div class="list-header">
                <span>Существующие переходы</span>
              </div>
              <div id="routesList" class="list"></div>
            </div>
            <div class="segment">
              <div class="list-header">
                <span>Редактор перехода</span>
                <span id="trEditState" class="muted">Создание нового перехода</span>
              </div>
              <div id="condList" class="list"></div>
              <div class="toolbar">
                <button class="btn ghost" id="btnAddCond">+ условие</button>
                <span class="right"></span>
                <button class="btn ghost sm" id="btnResetTransition" type="button">Очистить</button>
                <button class="btn ok" id="btnUpdateTransition" type="button">Сохранить изменения</button>
                <button class="btn primary" id="btnCreateTransition" type="button">Создать переход</button>
              </div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h2>Справочники</h2>
            <span class="muted">для select / multiselect</span>
          </div>
          <div class="panel-body">
            <div class="segment">
              <div class="segment-title">Новый справочник</div>
              <div class="row">
                <label style="flex:1 1 160px">Код<input id="d_code" type="text" placeholder="employment_type" /></label>
                <label style="flex:1 1 220px">Название<input id="d_title" type="text" placeholder="Тип занятости" /></label>
              </div>
              <div id="dictValues" class="list"></div>
              <div class="toolbar">
                <button class="btn ghost" id="btnAddDictVal">+ значение</button>
                <span class="right"></span>
                <button class="btn primary" id="btnCreateDict">Создать справочник</button>
              </div>
            </div>
            <div class="segment">
              <div class="segment-title">Существующие справочники</div>
              <label>Справочники<select id="dictsSelect"></select></label>
            </div>
          </div>
        </div>
      </main>
    </div>
  </section>

  <!-- ARCHIVE -->
  <section id="archive" data-display="block" style="display:none">
    <div class="panel">
      <div class="panel-header">
        <h2>Заполненные анкеты</h2>
        <span class="muted mono">По выбранной форме</span>
      </div>
      <div class="panel-body">
        <div class="hint-block">Следите за живыми инстансами формы: ответы пользователя отображаются с учётом условий видимости и переходов, настроенных в конструкторе.</div>
        <div class="toolbar">
          <span class="muted">Используется текущая форма из вкладки «Админ»</span>
          <span class="right"><button class="btn ghost" id="btnReloadInstances">Обновить</button></span>
        </div>
        <div class="grid cols-2" style="gap:12px">
          <div class="segment" style="height:100%">
            <div class="segment-title">Инстансы</div>
            <div id="instancesList" class="list"></div>
          </div>
          <div class="segment" style="height:100%">
            <div class="segment-title">Ответы и шаги</div>
            <div id="instanceDetails" class="code mono" style="min-height:220px">Выберите инстанс формы</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- USER -->
  <section id="user" class="grid cols-2" style="display:none">
    <div class="panel">
      <h2>Запуск анкеты</h2>
      <div class="row">
        <label style="flex:1 1 120px">User ID<input id="u_user" type="number" value="1"></label>
        <label style="flex:3 1 260px">Форма<select id="u_form"></select></label>
      </div>
      <div class="row">
        <button class="btn ok" id="btnStart">Старт</button>
        <label class="pill">Instance: <span id="u_instance" class="mono">—</span></label>
      </div>
      <div class="hr"></div>
      <div id="u_step"></div>
      <div class="hr"></div>
      <div id="u_nav" class="list"></div>
    </div>

    <div class="panel">
      <h2>История / Отладка</h2>
      <div id="log" class="code mono"></div>
    </div>
  </section>
</div>

<script>
const API = document.getElementById('apiBase').textContent.trim(); // http://127.0.0.1:8000
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function toast(msg, kind='info'){
  const color = {info:'#c7d2fe', ok:'#86efac', warn:'#fde68a', err:'#fecaca'}[kind] || '#c7d2fe';
  const log = $('#log');
  if(log){
    log.innerHTML = `<div style="color:${color}">${new Date().toLocaleTimeString()} — ${msg}</div>` + log.innerHTML;
  }
  const overlay = $('#toastOverlay');
  if(overlay){
    const item = document.createElement('div');
    item.className = `toast-item hide ${kind}`;
    item.textContent = msg;
    overlay.appendChild(item);
    requestAnimationFrame(()=> item.classList.remove('hide'));
    const ttl = 4200;
    setTimeout(()=> item.classList.add('hide'), ttl - 400);
    setTimeout(()=> item.remove(), ttl);
  }
}

/* Tabs */
const SECTION_DISPLAYS = {
  admin: {el: document.getElementById('admin'), display: 'block'},
  user: {el: document.getElementById('user'), display: 'grid'},
  archive: {el: document.getElementById('archive'), display: 'block'}
};
$$('.tab').forEach(tab=>{
  tab.onclick = ()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    tab.classList.add('active');
    Object.entries(SECTION_DISPLAYS).forEach(([key, cfg])=>{
      if(!cfg.el) return;
      cfg.el.style.display = (tab.dataset.tab===key) ? cfg.display : 'none';
    });
  };
});

/* Caches */
let cache = {
  forms: [], steps: [], dicts: [], stepTypes: [], dtypes: [], itypes: [], ops: [], visActions: []
};

let CURRENT_FORM_ID = null;
let CURRENT_STEP_ID = null;
let CURRENT_FIELD_ID = null;
let CURRENT_FORM_CODE = null;
let CURRENT_INSTANCE = null;
let FORM_FIELDS_CACHE = [];
let STEP_FIELDS_CACHE = {};
let FORM_CONDITION_FIELDS = [];
let FORM_CONDITION_FIELDS_FORM_ID = null;
let CURRENT_INSPECTED_INSTANCE = null;
let FORM_STEP_INDEX = {};
let FLOW_ROUTES_CACHE = {};
let VISIBILITY_RULES_CACHE = {};
let CURRENT_VISIBILITY_RULE_ID = null;
let CURRENT_ROUTE_ID = null;
let CURRENT_ROUTE_META = null;

/* Helpers */
async function getJSON(url, opt={}){ const r=await fetch(url,opt); if(!r.ok){throw new Error(await r.text());} return r.json(); }
function opt(value,label){ const o=document.createElement('option'); o.value=value; o.textContent=label; return o; }
function rowKV(k,v){ return `<div class="item"><span class="k">${k}</span> <span class="muted">→</span> ${v}</div>` }

function invalidateConditionFieldCache(){
  FORM_CONDITION_FIELDS = [];
  FORM_CONDITION_FIELDS_FORM_ID = null;
}

async function ensureConditionFieldsLoaded(){
  const formId = CURRENT_FORM_ID || +$('#formsSelect').value;
  if(!formId){
    invalidateConditionFieldCache();
    return [];
  }
  if(FORM_CONDITION_FIELDS_FORM_ID === formId && FORM_CONDITION_FIELDS.length){
    return FORM_CONDITION_FIELDS;
  }
  const steps = (cache.steps || []).slice().sort((a,b)=> (a.sort_order - b.sort_order) || (a.id - b.id));
  if(!steps.length){
    FORM_CONDITION_FIELDS = [];
    FORM_CONDITION_FIELDS_FORM_ID = formId;
    return FORM_CONDITION_FIELDS;
  }
  const aggregated = [];
  for(const step of steps){
    let fields = STEP_FIELDS_CACHE[step.id];
    if(!fields){
      const rows = await getJSON(`${API}/admin/steps/${step.id}/fields`).catch(()=>[]);
      const meta = {
        step_title: step.title,
        step_code: step.code,
        step_sort_order: step.sort_order,
      };
      fields = rows.map(r=>({
        ...r,
        ...meta,
      }));
      STEP_FIELDS_CACHE[step.id] = fields;
    } else {
      const meta = {
        step_title: step.title,
        step_code: step.code,
        step_sort_order: step.sort_order,
      };
      fields = fields.map(f=>({
        ...f,
        ...meta,
      }));
      STEP_FIELDS_CACHE[step.id] = fields;
    }
    aggregated.push(...fields.map(f=>({
      ...f,
    })));
  }
  aggregated.sort((a,b)=> (a.step_sort_order - b.step_sort_order) || (a.sort_order - b.sort_order) || (a.id - b.id));
  FORM_CONDITION_FIELDS = aggregated;
  FORM_CONDITION_FIELDS_FORM_ID = formId;
  return FORM_CONDITION_FIELDS;
}

/* Load dictionaries and refs */
async function loadRefs(){
  cache.dicts = await getJSON(`${API}/admin/dictionaries`).catch(()=>[]);
  cache.forms = await getJSON(`${API}/admin/forms`).catch(()=>[]);
  const [stepTypes, dtypes, itypes, ops] = await Promise.all([
    loadTableRows('step_types'),
    loadTableRows('field_data_types'),
    loadTableRows('field_input_types'),
    loadTableRows('compare_ops')
  ]);
  cache.stepTypeRows = stepTypes;
  cache.dataTypeRows = dtypes;
  cache.inputTypeRows = itypes;
  cache.opsRows = ops;
}

/* Because your FastAPI doesn’t expose dict endpoints,
   we’ll query via raw SQL-like endpoints you already have:
   - step_types, field_data_types, field_input_types, compare_ops
   We’ll implement minimal fetchers: */

async function loadTableRows(name){
  try{
    const r = await fetch(`${API}/raw/${name}`); // optional custom route; if not present fallback via seed mirrors
    if(r.ok) return r.json();
  }catch(e){}
  // fallback quick readers (used by /admin endpoints internally) — emulate with simplified GETs:
  if(name==='step_types')      return [{code:'questionnaire',id:1,title:'Questionnaire'},{code:'upload',id:2,title:'File upload'},{code:'review',id:3,title:'Review'}];
  if(name==='field_data_types')return [{code:'string',id:1,title:'String'},{code:'text',id:2,title:'Text'},{code:'integer',id:3,title:'Integer'},{code:'decimal',id:4,title:'Decimal'},{code:'boolean',id:5,title:'Boolean'},{code:'date',id:6,title:'Date'},{code:'datetime',id:7,title:'Datetime'}];
  if(name==='field_input_types')return [{code:'input',id:1,title:'Input'},{code:'textarea',id:2,title:'Textarea'},{code:'select',id:3,title:'Select'},{code:'multiselect',id:4,title:'Multiselect'},{code:'checkbox',id:5,title:'Checkbox'},{code:'datepicker',id:6,title:'Date picker'}];
  if(name==='compare_ops')     return [
    {code:'eq',id:1,title:'Equals'},
    {code:'ne',id:2,title:'Not equals'},
    {code:'gt',id:3,title:'Greater than'},
    {code:'gte',id:4,title:'Greater or equal'},
    {code:'lt',id:5,title:'Less than'},
    {code:'lte',id:6,title:'Less or equal'},
    {code:'in',id:7,title:'In list'},
    {code:'not_in',id:8,title:'Not in list'},
    {code:'like',id:9,title:'Like'},
    {code:'ilike',id:10,title:'Case-insensitive like'},
    {code:'is_true',id:11,title:'Is true'},
    {code:'is_false',id:12,title:'Is false'},
    {code:'is_empty',id:13,title:'Is empty'},
    {code:'not_empty',id:14,title:'Not empty'}
  ];
  if(name==='visibility_actions') return [
    {code:'show',id:1,title:'Show'},
    {code:'hide',id:2,title:'Hide'}
  ];
  return [];
}

async function refreshForms(){
  cache.forms = await getJSON(`${API}/admin/forms`);
  const sel = $('#formsSelect'); sel.innerHTML='';
  const uform = $('#u_form'); uform.innerHTML='';
  cache.forms.forEach(f=>{
    sel.append(opt(f.id, `${f.title} (${f.code})`));
    uform.append(opt(f.id, `${f.title}`));
  });
  if(cache.forms[0]) {
    const first = cache.forms[0];
    sel.value = first.id;
    uform.value = first.id;
    CURRENT_FORM_ID = first.id;
    CURRENT_FORM_CODE = first.code;
    showFormInfo(first);
    await refreshSteps();
    await refreshInstances();
  } else {
    CURRENT_FORM_ID = null;
    CURRENT_FORM_CODE = null;
  }
}

function showFormInfo(f){
  $('#formInfo').textContent = `id=${f.id} start_step_id=${f.start_step_id ?? '—'} active=${f.is_active}`;
}

async function refreshSteps(){
  const formId = +$('#formsSelect').value;
  if(!formId) return;
  STEP_FIELDS_CACHE = {};
  FLOW_ROUTES_CACHE = {};
  invalidateConditionFieldCache();
  const rows = await getJSON(`${API}/admin/forms/${formId}/steps`);
  cache.steps = rows;
  const listEl = $('#stepsList');
  const fldSel = $('#fld_step');
  const srcSel = $('#tr_src');
  const dstSel = $('#tr_dst');
  [listEl, fldSel, srcSel, dstSel].forEach(el=> el && (el.innerHTML=''));

  let nextSelected = CURRENT_STEP_ID && rows.some(s=>s.id===CURRENT_STEP_ID)
    ? CURRENT_STEP_ID
    : (rows[0]?.id ?? null);

  rows.forEach(s=>{
    const info = `${s.title} • ${s.step_type_code} • order ${s.sort_order}${s.is_terminal?' • финальный':''}`;
    const item = document.createElement('div');
    item.className = `item clickable${s.id===nextSelected?' active':''}`;
    item.dataset.stepId = s.id;
    item.innerHTML = `<div class="row" style="justify-content:space-between"><strong>${s.code}</strong><span class="muted">#${s.id}</span></div><div class="muted">${info}</div>`;
    item.onclick = ()=> selectStep(s.id);
    listEl.appendChild(item);
    fldSel.append(opt(s.id, s.title));
    srcSel.append(opt(s.id, s.title));
    dstSel.append(opt(s.id, s.title));
  });

  if(nextSelected){
    fldSel.value = nextSelected;
    srcSel.value = nextSelected;
  }

  FORM_STEP_INDEX[formId] = rows.reduce((acc, step)=>{ acc[step.code] = step; return acc; }, {});
  CURRENT_STEP_ID = nextSelected;
  const selectedStep = cache.steps.find(s=>s.id===CURRENT_STEP_ID);
  fillStepForm(selectedStep);
  await refreshFields(nextSelected);
  await refreshTransitionFields(nextSelected);
  await refreshFlowRoutes();
  await refreshRoutesList();
  await refreshVisibilityList();
  await resetVisibilityBuilder();
}

async function refreshDicts(){
  cache.dicts = await getJSON(`${API}/admin/dictionaries`);
  const sel = $('#dictsSelect'); sel.innerHTML='';
  const fldSel = $('#fld_dict'); fldSel.innerHTML='';
  cache.dicts.forEach(d=>{ sel.append(opt(d.code, `${d.title} (${d.code})`)); fldSel.append(opt(d.code, `${d.title}`)); });
}

async function refreshRefs(){
  const [stepTypes, dtypes, itypes, ops, visActions] = await Promise.all([
    loadTableRows('step_types'),
    loadTableRows('field_data_types'),
    loadTableRows('field_input_types'),
    loadTableRows('compare_ops'),
    loadTableRows('visibility_actions')
  ]);
  cache.stepTypes=stepTypes; cache.dtypes=dtypes; cache.itypes=itypes; cache.ops=ops; cache.visActions = visActions;
  const sTypeSel = $('#s_type'); sTypeSel.innerHTML='';
  stepTypes.forEach(x => sTypeSel.append(opt(x.code, x.title)));
  const dtSel = $('#fld_dtype'); dtSel.innerHTML='';
  dtypes.forEach(x => dtSel.append(opt(x.code, x.title)));
  const itSel = $('#fld_input'); itSel.innerHTML='';
  itypes.forEach(x => itSel.append(opt(x.code, x.title)));
  const visSelect = $('#vis_action');
  if(visSelect){
    visSelect.innerHTML='';
    visActions.forEach(x=> visSelect.append(opt(x.code, x.title)));
  }
}

async function refreshFields(stepId = null){
  const targetStepId = stepId || CURRENT_STEP_ID || +$('#fld_step').value;
  if(!targetStepId){ $('#fieldsList').innerHTML=''; FORM_FIELDS_CACHE=[]; return; }
  CURRENT_STEP_ID = targetStepId;
  $('#fld_step').value = targetStepId;
  const rows = await getJSON(`${API}/admin/steps/${targetStepId}/fields`);
  const step = cache.steps.find(s=>s.id===targetStepId);
  const meta = step ? {
    step_title: step.title,
    step_code: step.code,
    step_sort_order: step.sort_order,
  } : {
    step_title: '',
    step_code: '',
    step_sort_order: 0,
  };
  FORM_FIELDS_CACHE = rows.map(r=>({
    ...r,
    ...meta,
  }));
  STEP_FIELDS_CACHE[targetStepId] = FORM_FIELDS_CACHE.map(f=>({
    ...f,
  }));
  invalidateConditionFieldCache();
  populateVisibilityTargetSelect();
  const list = $('#fieldsList'); list.innerHTML='';
  let nextField = CURRENT_FIELD_ID && FORM_FIELDS_CACHE.some(f=>f.id===CURRENT_FIELD_ID)
    ? CURRENT_FIELD_ID
    : (FORM_FIELDS_CACHE[0]?.id ?? null);

  FORM_FIELDS_CACHE.forEach(f=>{
    const opts = (f.options||[]).map(o=>o.value_code).join(', ');
    const item = document.createElement('div');
    item.className = `item clickable${f.id===nextField?' active':''}`;
    item.dataset.fieldId = f.id;
    item.innerHTML = `<div class="row" style="justify-content:space-between"><strong>${f.code}</strong><span class="muted">#${f.id}</span></div>`+
      `<div class="muted">${f.title} • ${f.input_type_code}/${f.data_type_code} • order ${f.sort_order}${f.is_required?' • required':''}${f.default_hidden?' • hidden':''}${opts?` • opts: ${opts}`:''}${f.dictionary_code?` • dict:${f.dictionary_code}`:''}</div>`;
    item.onclick = ()=> selectField(f.id);
    list.appendChild(item);
  });

  CURRENT_FIELD_ID = nextField;
  if(nextField) selectField(nextField, {silent:true});
  else resetFieldForm();
  await refreshTransitionFields();
}

function fillStepForm(step){
  if(step){
    $('#s_code').value = step.code;
    $('#s_title').value = step.title;
    $('#s_order').value = step.sort_order;
    $('#s_type').value = step.step_type_code;
    $('#s_terminal').checked = !!step.is_terminal;
    const form = cache.forms.find(f=>f.id===CURRENT_FORM_ID);
    $('#s_start').checked = form ? form.start_step_id === step.id : false;
  } else {
    $('#s_title').value = '';
    $('#s_order').value = 100;
    $('#s_terminal').checked = false;
    $('#s_start').checked = false;
  }
}

function resetStepForm(){
  CURRENT_STEP_ID = null;
  $('#s_code').value = '';
  $('#s_title').value = '';
  $('#s_order').value = 100;
  $('#s_terminal').checked = false;
  $('#s_start').checked = false;
  $('#s_type').selectedIndex = 0;
  $$('#stepsList .item').forEach(el=>el.classList.remove('active'));
}

async function selectStep(stepId){
  if(!stepId) return;
  CURRENT_STEP_ID = stepId;
  $('#fld_step').value = stepId;
  const step = cache.steps.find(s=>s.id===stepId);
  fillStepForm(step);
  $$('#stepsList .item').forEach(el=>{
    el.classList.toggle('active', +el.dataset.stepId === stepId);
  });
  await refreshFields(stepId);
  resetTransitionBuilder();
  await refreshRoutesList();
  await refreshVisibilityList();
  await resetVisibilityBuilder();
}

function resetFieldForm(){
  CURRENT_FIELD_ID = null;
  $('#fld_code').value = '';
  $('#fld_title').value = '';
  $('#fld_dtype').selectedIndex = 0;
  $('#fld_input').selectedIndex = 0;
  $('#fld_req').checked = false;
  $('#fld_hidden').checked = false;
  $('#fld_order').value = 100;
  $('#fld_dict').selectedIndex = 0;
  $('#fldOpts').innerHTML='';
  $('#fldOpts').style.display='none';
  $('#fldOptsBtns').style.display='none';
  $('#fldDictRow').style.display='none';
  $('#fld_input').dispatchEvent(new Event('change'));
  $$('#fieldsList .item').forEach(el=>el.classList.remove('active'));
}

function fillFieldForm(field){
  if(!field){ resetFieldForm(); return; }
  CURRENT_FIELD_ID = field.id;
  $('#fld_code').value = field.code;
  $('#fld_title').value = field.title;
  $('#fld_dtype').value = field.data_type_code;
  $('#fld_input').value = field.input_type_code;
  $('#fld_req').checked = !!field.is_required;
  $('#fld_hidden').checked = !!field.default_hidden;
  $('#fld_order').value = field.sort_order;
  $('#fld_input').dispatchEvent(new Event('change'));

  if(field.input_type_code === 'select' || field.input_type_code === 'multiselect'){
    if(field.dictionary_code){
      $('#fld_dict').value = field.dictionary_code;
      $('#fldOpts').innerHTML='';
    } else {
      $('#fldOpts').innerHTML='';
      field.options.forEach(optData => addFieldOptionRow(optData));
    }
  } else {
    $('#fldOpts').innerHTML='';
  }

  $$('#fieldsList .item').forEach(el=>{
    el.classList.toggle('active', +el.dataset.fieldId === field.id);
  });
}

function selectField(fieldId, {silent=false}={}){
  const field = FORM_FIELDS_CACHE.find(f=>f.id===fieldId);
  if(!field){ resetFieldForm(); return; }
  fillFieldForm(field);
  if(!silent){ toast(`Редактирование поля ${field.code}`); }
}

function formatConditionValue(cond){
  if(cond.option_code) return cond.option_code;
  if(cond.value_bool === true || cond.value_bool === false) return cond.value_bool ? 'true' : 'false';
  if(cond.value_num !== null && cond.value_num !== undefined) return cond.value_num;
  if(cond.value_text) return cond.value_text;
  if(cond.value_date) return cond.value_date;
  if(cond.rhs_field_code) return `field:${cond.rhs_field_code}`;
  return '';
}

function renderConditionsList(conditions){
  if(!conditions || !conditions.length) return '<div class="muted">Без условий</div>';
  return conditions.map(cond=>
    `<div class="mono">${cond.field_title || cond.field_code} (${cond.field_code}) ${cond.op_title || cond.op_code} ${formatConditionValue(cond)}</div>`
  ).join('');
}

/* Admin actions */
$('#btnCreateForm').onclick = async ()=>{
  const payload = {code:$('#f_code').value.trim(), title:$('#f_title').value.trim(), description:$('#f_desc').value.trim()};
  const r = await getJSON(`${API}/admin/forms`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}).catch(e=>{toast(e.message,'err');});
  if(r){ toast(`Создана форма #${r.id}`,'ok'); await refreshForms();}
};

$('#formsSelect').onchange = async ()=>{
  const formId = +$('#formsSelect').value;
  CURRENT_FORM_ID = formId;
  const f = cache.forms.find(x=>x.id==formId);
  if(f){
    CURRENT_FORM_CODE = f.code;
    showFormInfo(f);
  }
  await refreshSteps();
  await refreshInstances();
};

$('#btnCreateStep').onclick = async ()=>{
  const formId = +$('#formsSelect').value;
  const payload = {code:$('#s_code').value.trim(), title:$('#s_title').value.trim(), step_type_code:$('#s_type').value, sort_order:+$('#s_order').value, is_terminal:$('#s_terminal').checked};
  const r = await getJSON(`${API}/admin/forms/${formId}/steps`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}).catch(e=>toast(e.message,'err'));
  if(r){ toast(`Добавлен шаг #${r.id}`,'ok'); CURRENT_STEP_ID = r.id; await refreshSteps(); }
};

$('#btnReloadSteps').onclick = refreshSteps;

$('#btnUpdateStep').onclick = async ()=>{
  if(!CURRENT_STEP_ID){ toast('Сначала выберите шаг','warn'); return; }
  const formId = +$('#formsSelect').value;
  const payload = {
    title: $('#s_title').value.trim(),
    step_type_code: $('#s_type').value,
    sort_order: +$('#s_order').value,
    is_terminal: $('#s_terminal').checked,
    is_start: $('#s_start').checked
  };
  const r = await getJSON(`${API}/admin/forms/${formId}/steps/${CURRENT_STEP_ID}`, {
    method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
  }).catch(e=>toast(e.message,'err'));
  if(r){
    toast('Шаг обновлён','ok');
    const updatedForm = await getJSON(`${API}/admin/forms/${formId}`).catch(()=>null);
    if(updatedForm){
      const idx = cache.forms.findIndex(f=>f.id===formId);
      if(idx>=0) cache.forms[idx] = updatedForm;
      showFormInfo(updatedForm);
    }
    await refreshSteps();
  }
};

$('#btnResetStep').onclick = resetStepForm;

/* Dict creation UI */
function addDictValueRow(){
  const wrap = document.createElement('div'); wrap.className='row';
  wrap.innerHTML = `
    <label style="flex:1 1 160px">Код<input type="text" class="dv_code" placeholder="self_employed"></label>
    <label style="flex:2 1 220px">Значение<input type="text" class="dv_label" placeholder="Самозанятый"></label>
    <label style="flex:1 1 120px">Порядок<input type="number" class="dv_sort" value="100"></label>
    <button class="btn error" onclick="this.parentElement.remove()">×</button>`;
  $('#dictValues').append(wrap);
}
$('#btnAddDictVal').onclick = addDictValueRow;

$('#btnCreateDict').onclick = async ()=>{
  const values = $$('#dictValues .row').map(r=>({
    value_code:r.querySelector('.dv_code').value.trim(),
    value_label:r.querySelector('.dv_label').value.trim(),
    sort_order:+r.querySelector('.dv_sort').value||100
  })).filter(v=>v.value_code);
  const payload = {code:$('#d_code').value.trim(), title:$('#d_title').value.trim(), values};
  const r = await getJSON(`${API}/admin/dictionaries`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}).catch(e=>toast(e.message,'err'));
  if(r){ toast(`Создан справочник ${r.code}`,'ok'); $('#dictValues').innerHTML=''; await refreshDicts(); }
};

$('#fld_input').onchange = ()=>{
  const t = $('#fld_input').value;
  const showSelect = (t==='select'||t==='multiselect');
  $('#fldDictRow').style.display = showSelect?'flex':'none';
  $('#fldOpts').style.display = showSelect?'block':'none';
  $('#fldOptsBtns').style.display = showSelect?'flex':'none';
};

function addFieldOptionRow(data={}){
  const wrap=document.createElement('div'); wrap.className='row';
  wrap.innerHTML = `
    <label style="flex:1 1 160px">Код<input type="text" class="fo_code" placeholder="full_time"></label>
    <label style="flex:2 1 220px">Метка<input type="text" class="fo_label" placeholder="Полная занятость"></label>
    <label style="flex:1 1 120px">Порядок<input type="number" class="fo_sort" value="100"></label>
    <button class="btn error" onclick="this.parentElement.remove()">×</button>`;
  wrap.querySelector('.fo_code').value = data.value_code ?? '';
  wrap.querySelector('.fo_label').value = data.value_label ?? '';
  wrap.querySelector('.fo_sort').value = data.sort_order ?? 100;
  $('#fldOpts').append(wrap);
}
$('#btnAddFldOpt').onclick = addFieldOptionRow;

$('#btnCreateField').onclick = async ()=>{
  const stepId = +$('#fld_step').value;
  const payload = {
    code:$('#fld_code').value.trim(),
    title:$('#fld_title').value.trim(),
    data_type_code:$('#fld_dtype').value,
    input_type_code:$('#fld_input').value,
    is_required:$('#fld_req').checked,
    default_hidden:$('#fld_hidden').checked,
    sort_order:+$('#fld_order').value||100
  };
  const dictCode = $('#fld_dict').value;
  const hasLocalOpts = $$('#fldOpts .row').length>0;
  if((payload.input_type_code==='select'||payload.input_type_code==='multiselect')){
    if(hasLocalOpts){
      payload.options = $$('#fldOpts .row').map(r=>({
        value_code:r.querySelector('.fo_code').value.trim(),
        value_label:r.querySelector('.fo_label').value.trim(),
        sort_order:+r.querySelector('.fo_sort').value||100
      })).filter(v=>v.value_code);
    }else{
      payload.dictionary_code = dictCode || null;
    }
  }
  const r = await getJSON(`${API}/admin/steps/${stepId}/fields`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}).catch(e=>toast(e.message,'err'));
  if(r){ toast(`Поле создано: ${r.code}`,'ok'); CURRENT_FIELD_ID = r.id; await refreshFields(); }
};

$('#btnReloadFields').onclick = refreshFields;

$('#btnUpdateField').onclick = async ()=>{
  if(!CURRENT_FIELD_ID){ toast('Сначала выберите поле','warn'); return; }
  const payload = {
    code: $('#fld_code').value.trim(),
    title: $('#fld_title').value.trim(),
    data_type_code: $('#fld_dtype').value,
    input_type_code: $('#fld_input').value,
    is_required: $('#fld_req').checked,
    default_hidden: $('#fld_hidden').checked,
    sort_order: +$('#fld_order').value || 100
  };
  const dictCode = $('#fld_dict').value;
  const hasLocalOpts = $$('#fldOpts .row').length>0;
  if(payload.input_type_code==='select' || payload.input_type_code==='multiselect'){
    if(hasLocalOpts){
      payload.options = $$('#fldOpts .row').map(r=>({
        value_code:r.querySelector('.fo_code').value.trim(),
        value_label:r.querySelector('.fo_label').value.trim(),
        sort_order:+r.querySelector('.fo_sort').value||100
      })).filter(v=>v.value_code);
    } else {
      payload.dictionary_code = dictCode || null;
    }
  }
  const r = await getJSON(`${API}/admin/fields/${CURRENT_FIELD_ID}`, {
    method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
  }).catch(e=>toast(e.message,'err'));
  if(r){ toast(`Поле обновлено: ${r.code}`,'ok'); CURRENT_FIELD_ID = r.id; await refreshFields(); await refreshVisibilityList(); }
};

$('#btnResetField').onclick = resetFieldForm;

$('#btnReloadInstances').onclick = refreshInstances;

$('#fld_step').onchange = ()=>{
  const stepId = +$('#fld_step').value;
  if(stepId) selectStep(stepId);
};

/* Transition builder */
function getTransitionFields(stepId = null){
  const sourceId = stepId || +$('#tr_src').value;
  if(!sourceId) return [];
  return STEP_FIELDS_CACHE[sourceId] || [];
}

async function refreshTransitionFields(stepId = null){
  const sourceId = stepId || +$('#tr_src').value;
  if(!sourceId){ return []; }
  if(!STEP_FIELDS_CACHE[sourceId]){
    const rows = await getJSON(`${API}/admin/steps/${sourceId}/fields`).catch(()=>[]);
    const step = cache.steps.find(s=>s.id===sourceId);
    const meta = step ? {
      step_title: step.title,
      step_code: step.code,
      step_sort_order: step.sort_order,
    } : {
      step_title: '',
      step_code: '',
      step_sort_order: 0,
    };
    STEP_FIELDS_CACHE[sourceId] = rows.map(r=>({
      ...r,
      ...meta,
    }));
  } else {
    const step = cache.steps.find(s=>s.id===sourceId);
    const meta = step ? {
      step_title: step.title,
      step_code: step.code,
      step_sort_order: step.sort_order,
    } : {
      step_title: '',
      step_code: '',
      step_sort_order: 0,
    };
    STEP_FIELDS_CACHE[sourceId] = STEP_FIELDS_CACHE[sourceId].map(f=>({
      ...f,
      ...meta,
    }));
  }
  const fields = STEP_FIELDS_CACHE[sourceId];
  const options = fields.map(f=>`<option value="${f.code}">${f.title} (${f.code})</option>`).join('');
  $$('#condList .c_field').forEach(sel=>{
    const current = sel.value;
    sel.innerHTML = options;
    if(fields.some(f=>f.code===current)){
      sel.value = current;
    } else if(fields[0]){
      sel.value = fields[0].code;
    }
    const row = sel.closest('.condition-row');
    if(row){
      const op = row.querySelector('.c_op')?.value || 'eq';
      const field = fields.find(f=>f.code === sel.value) || null;
      updateConditionValueControl(row, 'transition', field, op);
    }
  });
  return fields;
}

function resolveConditionValue(field, op, raw){
  const cond = {value_text:null, value_num:null, value_bool:null, value_date:null, option_code:null};
  const trimmed = raw.trim();
  if(['is_true','is_false','is_empty','not_empty'].includes(op) || !trimmed){
    if(op==='is_true') cond.value_bool = true;
    if(op==='is_false') cond.value_bool = false;
    return cond;
  }
  if(field && (field.input_type_code==='select' || field.input_type_code==='multiselect')){
    cond.option_code = trimmed;
    return cond;
  }
  if(field && (field.data_type_code==='integer' || field.data_type_code==='decimal')){
    const num = Number(trimmed);
    if(!Number.isNaN(num)){
      cond.value_num = num;
      return cond;
    }
  }
  if(field && field.data_type_code==='boolean'){
    const lower = trimmed.toLowerCase();
    if(['true','1','yes','да','on'].includes(lower)) cond.value_bool = true;
    else if(['false','0','no','нет','off'].includes(lower)) cond.value_bool = false;
    else cond.value_bool = lower === 'true';
    return cond;
  }
  if(field && field.data_type_code==='date'){
    cond.value_date = trimmed;
    return cond;
  }
  cond.value_text = trimmed;
  return cond;
}

function conditionScopeConfig(scope){
  if(scope==='visibility') return {fieldClass:'v_field', opClass:'v_op', valueClass:'v_val'};
  return {fieldClass:'c_field', opClass:'c_op', valueClass:'c_val'};
}

function getConditionInitialValue(condition, field, op){
  if(!condition) return '';
  if(condition.option_code !== null && condition.option_code !== undefined){
    if(field && (field.input_type_code === 'multiselect' || op === 'in' || op === 'not_in')){
      return String(condition.option_code).split(',').map(v=>v.trim()).filter(Boolean);
    }
    return String(condition.option_code);
  }
  if(condition.value_bool !== null && condition.value_bool !== undefined){
    return condition.value_bool ? 'true' : 'false';
  }
  if(condition.value_num !== null && condition.value_num !== undefined){
    return String(condition.value_num);
  }
  if(condition.value_date !== null && condition.value_date !== undefined){
    return condition.value_date;
  }
  if(condition.value_text !== null && condition.value_text !== undefined){
    return condition.value_text;
  }
  return '';
}

function createConditionValueControl(field, op, existingRaw, scope){
  const {valueClass} = conditionScopeConfig(scope);
  const rawValue = existingRaw ?? '';
  const normalize = value => (value === undefined || value === null) ? '' : String(value);
  if(field && (field.input_type_code === 'select' || field.input_type_code === 'multiselect')){
    const control = document.createElement('select');
    control.classList.add(valueClass);
    const multi = field.input_type_code === 'multiselect' || op === 'in' || op === 'not_in';
    if(multi){
      control.multiple = true;
      const size = Math.min(6, Math.max((field.options||[]).length, 3));
      control.size = size;
    } else {
      control.appendChild(opt('', '— выберите —'));
    }
    (field.options || []).forEach(o=> control.appendChild(opt(o.value_code, o.value_label)));
    if(Array.isArray(rawValue)){
      rawValue.forEach(val=>{
        const option = Array.from(control.options).find(o=>o.value === normalize(val));
        if(option) option.selected = true;
      });
    } else if(rawValue){
      control.value = normalize(rawValue);
    }
    return control;
  }
  if(field && field.data_type_code === 'boolean'){
    const control = document.createElement('select');
    control.classList.add(valueClass);
    control.appendChild(opt('', '— выберите —'));
    control.appendChild(opt('true', 'Да'));
    control.appendChild(opt('false', 'Нет'));
    if(rawValue){ control.value = normalize(rawValue); }
    return control;
  }
  if(field && (field.data_type_code === 'integer' || field.data_type_code === 'decimal')){
    const control = document.createElement('input');
    control.type = 'number';
    control.classList.add(valueClass);
    if(field.data_type_code === 'decimal') control.step = 'any';
    if(rawValue){ control.value = normalize(rawValue); }
    return control;
  }
  if(field && field.data_type_code === 'date'){
    const control = document.createElement('input');
    control.type = 'date';
    control.classList.add(valueClass);
    if(rawValue){ control.value = normalize(rawValue); }
    return control;
  }
  if(field && field.data_type_code === 'datetime'){
    const control = document.createElement('input');
    control.type = 'datetime-local';
    control.classList.add(valueClass);
    if(rawValue){ control.value = normalize(rawValue); }
    return control;
  }
  const control = document.createElement('input');
  control.type = 'text';
  control.placeholder = 'value / option_code / true|false';
  control.classList.add(valueClass);
  if(Array.isArray(rawValue)){
    control.value = rawValue.join(',');
  } else if(rawValue){
    control.value = normalize(rawValue);
  }
  return control;
}

function readConditionControlValue(row, scope){
  const {valueClass} = conditionScopeConfig(scope);
  const control = row.querySelector(`.${valueClass}`);
  if(!control) return '';
  if(control.tagName === 'SELECT'){
    if(control.multiple){
      return Array.from(control.selectedOptions).map(o=>o.value).filter(Boolean).join(',');
    }
    return control.value || '';
  }
  if(control.type === 'checkbox'){
    return control.checked ? 'true' : '';
  }
  return control.value || '';
}

function lookupConditionField(scope, code){
  if(!code) return null;
  if(scope === 'visibility'){
    return (FORM_CONDITION_FIELDS || []).find(f=>f.code === code) || null;
  }
  if(scope === 'transition'){
    const sourceId = +$('#tr_src').value;
    const fields = getTransitionFields(sourceId) || [];
    return fields.find(f=>f.code === code) || null;
  }
  return null;
}

function updateConditionValueControl(row, scope, field, op, presetRaw){
  const slot = row.querySelector('.cond-value-slot');
  if(!slot) return;
  const raw = presetRaw !== undefined ? presetRaw : readConditionControlValue(row, scope);
  slot.innerHTML = '';
  const control = createConditionValueControl(field, op, raw, scope);
  slot.appendChild(control);
}

function attachConditionRowHandlers(row, scope){
  const {fieldClass, opClass} = conditionScopeConfig(scope);
  const fieldSelect = row.querySelector(`.${fieldClass}`);
  const opSelect = row.querySelector(`.${opClass}`);
  if(fieldSelect){
    fieldSelect.addEventListener('change', ()=>{
      const field = lookupConditionField(scope, fieldSelect.value);
      const op = opSelect ? opSelect.value : 'eq';
      updateConditionValueControl(row, scope, field, op);
    });
  }
  if(opSelect){
    opSelect.addEventListener('change', ()=>{
      const field = fieldSelect ? lookupConditionField(scope, fieldSelect.value) : null;
      updateConditionValueControl(row, scope, field, opSelect.value);
    });
  }
}

function ensureConditionFieldOption(fieldSelect, condition, label){
  if(!condition || !condition.field_code) return;
  const exists = Array.from(fieldSelect.options).some(o=>o.value === condition.field_code);
  if(!exists){
    fieldSelect.append(opt(condition.field_code, label || condition.field_code));
  }
}

function createConditionRow(scope, fields, condition=null){
  const cfg = conditionScopeConfig(scope);
  const row = document.createElement('div');
  row.className = 'row item condition-row';

  const fieldLabel = document.createElement('label');
  fieldLabel.style.flex = '2 1 240px';
  fieldLabel.append('Поле');
  const fieldSelect = document.createElement('select');
  fieldSelect.classList.add(cfg.fieldClass);
  if(!fields.length && condition?.field_code){
    ensureConditionFieldOption(fieldSelect, condition, condition.field_title || condition.field_code);
  }
  fields.forEach(f=>{
    const prefix = f.step_title ? `${f.step_title} › ` : '';
    fieldSelect.append(opt(f.code, `${prefix}${f.title} (${f.code})`));
  });
  fieldLabel.appendChild(fieldSelect);
  row.appendChild(fieldLabel);

  const opLabel = document.createElement('label');
  opLabel.style.flex = '1 1 160px';
  opLabel.append('Оператор');
  const opSelect = document.createElement('select');
  opSelect.classList.add(cfg.opClass);
  (cache.ops || []).forEach(o=> opSelect.append(opt(o.code, o.title)));
  opLabel.appendChild(opSelect);
  row.appendChild(opLabel);

  const valueLabel = document.createElement('label');
  valueLabel.style.flex = '2 1 240px';
  valueLabel.innerHTML = 'Значение<div class="cond-value-slot"></div>';
  row.appendChild(valueLabel);

  const removeBtn = document.createElement('button');
  removeBtn.className = 'btn error';
  removeBtn.type = 'button';
  removeBtn.textContent = '×';
  removeBtn.onclick = ()=> row.remove();
  row.appendChild(removeBtn);

  if(condition?.field_code && (fields.some(f=>f.code===condition.field_code) || fieldSelect.querySelector(`option[value="${condition.field_code}"]`))){
    fieldSelect.value = condition.field_code;
  }
  if(condition?.op_code){
    opSelect.value = condition.op_code;
  }

  const selectedField = lookupConditionField(scope, fieldSelect.value) || fields.find(f=>f.code===fieldSelect.value) || null;
  const initialRaw = getConditionInitialValue(condition, selectedField, opSelect.value);
  updateConditionValueControl(row, scope, selectedField, opSelect.value, initialRaw);
  attachConditionRowHandlers(row, scope);
  return row;
}

function getVisibilityTargetCodes(){
  return $$('#visTargets .target-pill').map(el=>el.dataset.code);
}

function ensureVisibilityTargetsPlaceholder(){
  const wrap = $('#visTargets');
  if(!wrap) return;
  if(!wrap.querySelector('.target-pill')){
    wrap.innerHTML = '<span class="muted">Пока не выбрано</span>';
  }
}

function populateVisibilityTargetSelect(){
  const select = $('#vis_target_select');
  if(!select) return;
  const fields = FORM_FIELDS_CACHE || [];
  const existing = getVisibilityTargetCodes();
  select.innerHTML='';
  if(!fields.length){
    select.append(opt('', 'Нет полей на шаге'));
    select.disabled = true;
    ensureVisibilityTargetsPlaceholder();
    return;
  }
  select.disabled = false;
  select.append(opt('', '— выберите —'));
  fields.forEach(f=>{
    if(existing.includes(f.code)) return;
    const label = `${f.title} (${f.code})${f.default_hidden?' [скрыто]':''}`;
    select.append(opt(f.code, label));
  });
  ensureVisibilityTargetsPlaceholder();
}

function addVisibilityTarget(code){
  const wrap = $('#visTargets');
  if(!wrap || !code) return;
  const field = FORM_FIELDS_CACHE.find(f=>f.code===code);
  if(!field){ toast('Поле не найдено на текущем шаге','warn'); return; }
  if(wrap.querySelector(`.target-pill[data-code="${code}"]`)) return;
  if(wrap.querySelector('.muted')) wrap.innerHTML='';
  const pill = document.createElement('span');
  pill.className='target-pill';
  pill.dataset.code = field.code;
  const btn = document.createElement('button');
  btn.type='button';
  btn.textContent='×';
  btn.onclick = ()=>{
    pill.remove();
    populateVisibilityTargetSelect();
    ensureVisibilityTargetsPlaceholder();
  };
  pill.textContent = `${field.title} (${field.code})${field.default_hidden?' [скрыто]':''}`;
  pill.appendChild(btn);
  wrap.appendChild(pill);
  populateVisibilityTargetSelect();
}

async function resetVisibilityBuilder(){
  CURRENT_VISIBILITY_RULE_ID = null;
  $('#vis_priority').value = 100;
  $('#vis_logic').value = 'AND';
  $('#vis_description').value = '';
  const actionSelect = $('#vis_action');
  if(actionSelect && actionSelect.options.length){ actionSelect.selectedIndex = 0; }
  const targets = $('#visTargets');
  if(targets){ targets.innerHTML=''; }
  const condList = $('#visCondList');
  if(condList){ condList.innerHTML=''; }
  populateVisibilityTargetSelect();
  ensureVisibilityTargetsPlaceholder();
  $$('#visibilityList .item').forEach(el=> el.classList.remove('active'));
  updateVisibilityEditState();
  await ensureConditionFieldsLoaded();
}

function updateVisibilityEditState(){
  const badge = $('#visEditState');
  if(!badge) return;
  if(CURRENT_VISIBILITY_RULE_ID){
    badge.textContent = `Редактирование правила #${CURRENT_VISIBILITY_RULE_ID}`;
  } else {
    badge.textContent = 'Создание нового правила';
  }
}

function resetTransitionBuilder(){
  CURRENT_ROUTE_ID = null;
  CURRENT_ROUTE_META = null;
  $('#tr_prio').value = 100;
  $('#tr_logic').value = 'AND';
  const dst = $('#tr_dst');
  if(dst && dst.options.length){ dst.selectedIndex = 0; }
  const condList = $('#condList');
  if(condList){ condList.innerHTML=''; }
  $$('#routesList .item').forEach(el=> el.classList.remove('active'));
  updateTransitionEditState();
}

function updateTransitionEditState(){
  const badge = $('#trEditState');
  if(!badge) return;
  if(CURRENT_ROUTE_ID){
    badge.textContent = `Редактирование перехода #${CURRENT_ROUTE_ID}`;
  } else {
    badge.textContent = 'Создание нового перехода';
  }
}

async function addVisibilityConditionRow(condition=null){
  const fields = await ensureConditionFieldsLoaded();
  if(!fields.length){ toast('Не удалось загрузить поля формы','warn'); return; }
  const row = createConditionRow('visibility', fields, condition);
  $('#visCondList').append(row);
}

async function refreshFlowRoutes(){
  const formId = CURRENT_FORM_ID || +$('#formsSelect').value;
  if(!formId){ FLOW_ROUTES_CACHE = {}; renderFlowDesigner(); return; }
  const steps = cache.steps || [];
  if(!steps.length){ FLOW_ROUTES_CACHE = {}; renderFlowDesigner(); return; }
  const entries = await Promise.all(steps.map(async step => {
    const routes = await getJSON(`${API}/admin/forms/${formId}/steps/${step.id}/routes`).catch(()=>[]);
    return [step.id, routes];
  }));
  FLOW_ROUTES_CACHE = Object.fromEntries(entries);
  renderFlowDesigner();
}

async function persistFlowOrder(orderedSteps){
  const formId = CURRENT_FORM_ID || +$('#formsSelect').value;
  if(!formId) return;
  let changed = false;
  for(let i=0;i<orderedSteps.length;i++){
    const step = orderedSteps[i];
    const desired = (i + 1) * 100;
    if(step.sort_order !== desired){
      changed = true;
      try{
        await getJSON(`${API}/admin/forms/${formId}/steps/${step.id}`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({sort_order: desired})
        });
      }catch(e){
        toast(`Не удалось сохранить порядок: ${e.message}`,'err');
        return;
      }
    }
  }
  if(changed){
    toast('Порядок шагов обновлён','ok');
    await refreshSteps();
  } else {
    renderFlowDesigner();
  }
}

async function handleFlowDrop(event, targetStepId){
  event.preventDefault();
  const sourceId = Number(event.dataTransfer.getData('text/plain'));
  if(!sourceId || sourceId === targetStepId) return;
  const ordered = (cache.steps || []).slice().sort((a,b)=> (a.sort_order - b.sort_order) || (a.id - b.id));
  const sourceIndex = ordered.findIndex(s=>s.id===sourceId);
  const targetIndex = ordered.findIndex(s=>s.id===targetStepId);
  if(sourceIndex === -1 || targetIndex === -1) return;
  const [moved] = ordered.splice(sourceIndex,1);
  const insertIndex = ordered.findIndex(s=>s.id===targetStepId);
  ordered.splice(insertIndex,0,moved);
  $$('.flow-node').forEach(el=>el.classList.remove('drag-over'));
  await persistFlowOrder(ordered);
}

function renderFlowDesigner(){
  const canvas = $('#flowCanvas');
  if(!canvas) return;
  canvas.innerHTML='';
  const steps = (cache.steps || []).slice().sort((a,b)=> (a.sort_order - b.sort_order) || (a.id - b.id));
  if(!steps.length){
    canvas.innerHTML = '<div class="flow-empty">Нет шагов в форме</div>';
    return;
  }
  steps.forEach(step=>{
    const node = document.createElement('div');
    node.className = 'flow-node';
    if(step.id === CURRENT_STEP_ID) node.classList.add('active');
    node.draggable = true;
    node.dataset.stepId = step.id;
    node.addEventListener('dragstart', e=>{
      node.classList.add('dragging');
      e.dataTransfer.effectAllowed='move';
      e.dataTransfer.setData('text/plain', String(step.id));
    });
    node.addEventListener('dragend', ()=>{
      node.classList.remove('dragging');
      node.classList.remove('drag-over');
    });
    node.addEventListener('dragover', e=>{
      e.preventDefault();
      node.classList.add('drag-over');
      e.dataTransfer.dropEffect='move';
    });
    node.addEventListener('dragleave', ()=> node.classList.remove('drag-over'));
    node.addEventListener('drop', e=> handleFlowDrop(e, step.id));
    node.onclick = ()=> selectStep(step.id);

    const header = document.createElement('div');
    header.className = 'flow-node-header';
    const metaParts = [`${step.code}`, `order ${step.sort_order}`];
    if(step.is_terminal) metaParts.push('финальный');
    header.innerHTML = `<strong>${step.title}</strong><span class="flow-node-meta">${metaParts.join(' • ')}</span>`;
    node.appendChild(header);

    const routes = FLOW_ROUTES_CACHE[step.id] || [];
    if(routes.length){
      const links = document.createElement('div');
      links.className = 'flow-links';
      routes.forEach(route=>{
        const link = document.createElement('div');
        link.className = 'flow-link';
        const target = cache.steps.find(s=>s.id===route.target_step_id);
        const targetTitle = target ? target.title : `#${route.target_step_id}`;
        const pieces = [`prio ${route.priority}`];
        if(route.conditions && route.conditions.length){
          pieces.push(`${route.conditions.length} усл.`);
        }
        link.innerHTML = `${targetTitle} <span class="muted">${pieces.join(' • ')}</span>`;
        links.appendChild(link);
      });
      node.appendChild(links);
    } else {
      const empty = document.createElement('div');
      empty.className = 'muted';
      empty.textContent = 'Нет переходов';
      node.appendChild(empty);
    }

    const actions = document.createElement('div');
    actions.className = 'flow-node-actions';
    const openBtn = document.createElement('button');
    openBtn.className = 'btn ghost sm';
    openBtn.type='button';
    openBtn.textContent = 'Открыть';
    openBtn.onclick = e=>{ e.stopPropagation(); selectStep(step.id); };
    actions.appendChild(openBtn);

    const routeBtn = document.createElement('button');
    routeBtn.className = 'btn primary sm';
    routeBtn.type='button';
    routeBtn.textContent = '+ переход';
    routeBtn.onclick = async e=>{
      e.stopPropagation();
      $('#tr_src').value = step.id;
      await refreshTransitionFields(step.id);
      selectStep(step.id);
      document.getElementById('tr_src')?.scrollIntoView({behavior:'smooth', block:'center'});
    };
    actions.appendChild(routeBtn);

    const visBtn = document.createElement('button');
    visBtn.className = 'btn ghost sm';
    visBtn.type='button';
    visBtn.textContent = '+ видимость';
    visBtn.onclick = e=>{
      e.stopPropagation();
      selectStep(step.id);
      document.getElementById('vis_action')?.focus();
    };
    actions.appendChild(visBtn);

    node.appendChild(actions);
    canvas.appendChild(node);
  });
}

async function refreshRoutesList(){
  const list = $('#routesList');
  if(!list) return;
  const formId = CURRENT_FORM_ID || +$('#formsSelect').value;
  const stepId = CURRENT_STEP_ID || +$('#fld_step').value;
  if(!formId || !stepId){ list.innerHTML = '<div class="item muted">Шаг не выбран</div>'; return; }
  const routes = await getJSON(`${API}/admin/forms/${formId}/steps/${stepId}/routes`).catch(e=>{
    list.innerHTML = `<div class="item muted">Ошибка: ${e.message}</div>`; return [];
  });
  FLOW_ROUTES_CACHE[stepId] = routes;
  if(CURRENT_ROUTE_ID && !routes.some(route=>route.id === CURRENT_ROUTE_ID)){
    resetTransitionBuilder();
  }
  if(!routes.length){
    list.innerHTML = '<div class="item muted">Переходы отсутствуют</div>';
    renderFlowDesigner();
    return;
  }
  list.innerHTML='';
  routes.forEach(route=>{
    const target = cache.steps.find(s=>s.id===route.target_step_id);
    const title = target ? `${target.title} (${target.code})` : `#${route.target_step_id}`;
    const item = document.createElement('div');
    const isActive = route.id === CURRENT_ROUTE_ID;
    item.className = `item clickable${isActive?' active':''}`;
    item.dataset.routeId = route.id;
    item.innerHTML = `
      <div class="row" style="justify-content:space-between"><strong>${title}</strong><span class="muted">prio ${route.priority}</span></div>
      <div class="muted">Логика: ${route.logic_op}${route.scenario_description?` • ${route.scenario_description}`:''}</div>
      ${route.description?`<div class="muted">${route.description}</div>`:''}
      ${renderConditionsList(route.conditions)}
    `;
    item.onclick = ()=> selectTransition(route.id);
    list.appendChild(item);
  });
  renderFlowDesigner();
}

async function selectVisibilityRule(ruleOrId){
  const stepId = CURRENT_STEP_ID || +$('#fld_step').value;
  const rule = typeof ruleOrId === 'object'
    ? ruleOrId
    : (VISIBILITY_RULES_CACHE[stepId] || []).find(r=>r.id === ruleOrId);
  if(!rule) return;
  CURRENT_VISIBILITY_RULE_ID = rule.id;
  const actionSelect = $('#vis_action');
  if(actionSelect){
    const exists = Array.from(actionSelect.options).some(o=>o.value === rule.action_code);
    if(!exists){
      actionSelect.append(opt(rule.action_code, rule.action_title || rule.action_code));
    }
    actionSelect.value = rule.action_code;
  }
  $('#vis_priority').value = rule.priority;
  $('#vis_logic').value = rule.logic_op;
  $('#vis_description').value = rule.scenario_description || '';
  const targetsWrap = $('#visTargets');
  if(targetsWrap){
    targetsWrap.innerHTML='';
    const orderedTargets = (rule.targets || []).slice().sort((a,b)=> (a.sort_order - b.sort_order) || (a.field_id - b.field_id));
    const fieldsOnStep = FORM_FIELDS_CACHE || [];
    orderedTargets.forEach(t=>{
      if(fieldsOnStep.some(f=>f.code === t.field_code)){
        addVisibilityTarget(t.field_code);
      } else {
        const pill = document.createElement('span');
        pill.className = 'target-pill';
        pill.dataset.code = t.field_code;
        pill.textContent = `${t.field_title || t.field_code}`;
        const btn = document.createElement('button');
        btn.type='button';
        btn.textContent='×';
        btn.onclick = ()=>{
          pill.remove();
          populateVisibilityTargetSelect();
          ensureVisibilityTargetsPlaceholder();
        };
        pill.appendChild(btn);
        targetsWrap.appendChild(pill);
      }
    });
  }
  const condList = $('#visCondList');
  if(condList){ condList.innerHTML=''; }
  await ensureConditionFieldsLoaded();
  const orderedConditions = (rule.conditions || []).slice().sort((a,b)=> (a.position - b.position) || (a.id - b.id));
  for(const cond of orderedConditions){
    await addVisibilityConditionRow(cond);
  }
  populateVisibilityTargetSelect();
  ensureVisibilityTargetsPlaceholder();
  $$('#visibilityList .item').forEach(el=> el.classList.toggle('active', +el.dataset.ruleId === rule.id));
  updateVisibilityEditState();
}

async function selectTransition(routeOrId){
  const stepId = CURRENT_STEP_ID || +$('#fld_step').value;
  const route = typeof routeOrId === 'object'
    ? routeOrId
    : (FLOW_ROUTES_CACHE[stepId] || []).find(r=>r.id === routeOrId);
  if(!route) return;
  CURRENT_ROUTE_ID = route.id;
  CURRENT_ROUTE_META = {
    description: route.description || null,
    scenario_description: route.scenario_description || null,
  };
  $('#tr_src').value = route.source_step_id;
  const fields = await refreshTransitionFields(route.source_step_id);
  const dstSelect = $('#tr_dst');
  if(dstSelect){
    const exists = Array.from(dstSelect.options).some(o=>+o.value === route.target_step_id);
    if(!exists){
      const targetStep = cache.steps.find(s=>s.id===route.target_step_id);
      const label = targetStep ? targetStep.title : `#${route.target_step_id}`;
      dstSelect.append(opt(route.target_step_id, label));
    }
    dstSelect.value = route.target_step_id;
  }
  $('#tr_prio').value = route.priority;
  $('#tr_logic').value = route.logic_op;
  const condList = $('#condList');
  if(condList){ condList.innerHTML=''; }
  const orderedConditions = (route.conditions || []).slice().sort((a,b)=> (a.position - b.position) || (a.id - b.id));
  if(orderedConditions.length){
    orderedConditions.forEach(cond=>{
      const row = createConditionRow('transition', fields, cond);
      $('#condList').append(row);
    });
  } else {
    const row = createConditionRow('transition', fields, null);
    $('#condList').append(row);
  }
  $$('#routesList .item').forEach(el=> el.classList.toggle('active', +el.dataset.routeId === route.id));
  updateTransitionEditState();
}

async function refreshVisibilityList(){
  const list = $('#visibilityList');
  if(!list) return;
  const formId = CURRENT_FORM_ID || +$('#formsSelect').value;
  const stepId = CURRENT_STEP_ID || +$('#fld_step').value;
  if(!formId || !stepId){ list.innerHTML = '<div class="item muted">Шаг не выбран</div>'; return; }
  const rules = await getJSON(`${API}/admin/forms/${formId}/steps/${stepId}/visibility`).catch(e=>{
    list.innerHTML = `<div class="item muted">Ошибка: ${e.message}</div>`; return [];
  });
  VISIBILITY_RULES_CACHE[stepId] = rules;
  if(CURRENT_VISIBILITY_RULE_ID && !rules.some(rule=>rule.id === CURRENT_VISIBILITY_RULE_ID)){
    await resetVisibilityBuilder();
  }
  if(!rules.length){ list.innerHTML = '<div class="item muted">Правила отсутствуют</div>'; return; }
  list.innerHTML='';
  rules.forEach(rule=>{
    const targets = rule.targets && rule.targets.length
      ? rule.targets.map(t=>`<span class="pill">${t.field_title || t.field_code}</span>`).join(' ')
      : '<span class="muted">—</span>';
    const item = document.createElement('div');
    const isActive = rule.id === CURRENT_VISIBILITY_RULE_ID;
    item.className = `item clickable${isActive?' active':''}`;
    item.dataset.ruleId = rule.id;
    item.innerHTML = `
      <div class="row" style="justify-content:space-between"><strong>${rule.action_title || rule.action_code}</strong><span class="muted">prio ${rule.priority}</span></div>
      <div class="muted">Логика: ${rule.logic_op}${rule.scenario_description?` • ${rule.scenario_description}`:''}</div>
      <div class="muted">Поля: ${targets}</div>
      ${renderConditionsList(rule.conditions)}
    `;
    item.onclick = ()=> selectVisibilityRule(rule.id);
    list.appendChild(item);
  });
}

async function refreshInstances(){
  const list = $('#instancesList');
  const details = $('#instanceDetails');
  if(!list) return;
  const formId = CURRENT_FORM_ID || +$('#formsSelect').value;
  list.innerHTML='';
  if(details) details.innerHTML = '—';
  if(!formId){ list.innerHTML = '<div class="item muted">Форма не выбрана</div>'; return; }
  const rows = await getJSON(`${API}/admin/forms/${formId}/instances`).catch(e=>{
    list.innerHTML = `<div class="item muted">Ошибка: ${e.message}</div>`; return [];
  });
  if(!rows.length){ list.innerHTML = '<div class="item muted">Инстансы отсутствуют</div>'; return; }
  list.innerHTML='';
  rows.forEach(row=>{
    const item = document.createElement('div');
    item.className = `item clickable${row.id===CURRENT_INSPECTED_INSTANCE?' active':''}`;
    item.dataset.id = row.id;
    const completed = row.completed_steps?.length || 0;
    const available = row.available_steps?.length || 0;
    item.innerHTML = `
      <div class="row" style="justify-content:space-between"><strong>#${row.id}</strong><span class="muted">${row.status_code}</span></div>
      <div class="muted">User: ${row.user_id} • шагов завершено: ${completed} • доступно: ${available}</div>
    `;
    item.onclick = ()=> loadInstanceDetails(row.id);
    list.appendChild(item);
  });
  if(rows[0]) await loadInstanceDetails(rows[0].id);
}

async function loadInstanceDetails(instanceId){
  const panel = $('#instanceDetails');
  if(!panel) return;
  CURRENT_INSPECTED_INSTANCE = instanceId;
  $$('#instancesList .item').forEach(el=>{
    el.classList.toggle('active', +el.dataset.id === instanceId);
  });
  const detail = await getJSON(`${API}/admin/instances/${instanceId}`).catch(e=>{
    panel.innerHTML = `<div class="muted">Ошибка: ${e.message}</div>`; return null;
  });
  if(!detail) return;
  const header = `<div class="muted">Форма ${detail.form_code} • пользователь ${detail.user_id} • статус ${detail.status_code}</div>`;
  const stepsHtml = detail.steps.map(step=>{
    const answers = step.answers && step.answers.length
      ? step.answers.map(ans=>`<div class="mono">${ans.field_title || ans.field_code}: ${Array.isArray(ans.value)?ans.value.join(', '):ans.value ?? '—'}</div>`).join('')
      : '<div class="muted">Ответов нет</div>';
    return `<div style="margin-top:8px"><strong>${step.step_title} (${step.step_code})</strong> — ${step.status || '—'}${answers}</div>`;
  }).join('<div class="divider"></div>');
  panel.innerHTML = header + (stepsHtml || '<div class="muted">Нет шагов</div>');
}

$('#btnAddCond').onclick = async ()=>{
  const sourceId = +$('#tr_src').value;
  if(!sourceId){ toast('Сначала выберите источник перехода','warn'); return; }
  let fields = getTransitionFields(sourceId);
  if(!fields.length){
    fields = await refreshTransitionFields(sourceId);
  }
  if(!fields.length){ toast('В выбранном шаге нет полей для условий','warn'); return; }
  const row = createConditionRow('transition', fields, null);
  $('#condList').append(row);
};

$('#btnAddVisTarget').onclick = ()=>{
  const select = $('#vis_target_select');
  if(!select) return;
  const code = select.value;
  if(!code){ toast('Выберите поле для видимости','warn'); return; }
  addVisibilityTarget(code);
};

$('#btnAddVisCond').onclick = ()=> addVisibilityConditionRow();

async function collectVisibilityPayload(){
  const formId = CURRENT_FORM_ID || +$('#formsSelect').value;
  const stepId = CURRENT_STEP_ID || +$('#fld_step').value;
  if(!formId || !stepId){ toast('Выберите шаг формы','warn'); return null; }
  const action = $('#vis_action').value;
  if(!action){ toast('Выберите действие','warn'); return null; }
  const priority = +$('#vis_priority').value || 100;
  const logic = $('#vis_logic').value;
  const description = $('#vis_description').value.trim();
  const targets = $$('#visTargets .target-pill').map((pill, idx)=>({
    field_code: pill.dataset.code,
    sort_order: (idx + 1) * 10
  }));
  if(!targets.length){ toast('Добавьте хотя бы одно целевое поле','warn'); return null; }
  const rows = $$('#visCondList .row');
  const fields = await ensureConditionFieldsLoaded();
  const conditions = rows.map((row, idx)=>{
    const fieldCode = row.querySelector('.v_field').value;
    const op = row.querySelector('.v_op').value;
    const raw = readConditionControlValue(row, 'visibility');
    const field = fields.find(f=>f.code===fieldCode) || {};
    const cond = {field_code:fieldCode, op_code:op, value_text:null, value_num:null, value_bool:null, value_date:null, option_code:null, position:(idx+1)*10};
    Object.assign(cond, resolveConditionValue(field, op, raw));
    return cond;
  });

  const payload = {
    action_code: action,
    priority,
    logic_op: logic,
    scenario_description: description || null,
    targets,
    conditions
  };

  return {formId, stepId, payload};
}

$('#btnCreateVisibilityRule').onclick = async ()=>{
  const data = await collectVisibilityPayload();
  if(!data) return;
  const {formId, stepId, payload} = data;

  const r = await getJSON(`${API}/admin/forms/${formId}/steps/${stepId}/visibility`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  }).catch(e=>toast(e.message,'err'));
  if(r){
    toast('Правило видимости создано','ok');
    await resetVisibilityBuilder();
    await refreshVisibilityList();
  }
};

$('#btnUpdateVisibilityRule').onclick = async ()=>{
  if(!CURRENT_VISIBILITY_RULE_ID){ toast('Выберите правило для редактирования','warn'); return; }
  const data = await collectVisibilityPayload();
  if(!data) return;
  const {formId, stepId, payload} = data;
  const url = `${API}/admin/forms/${formId}/steps/${stepId}/visibility/${CURRENT_VISIBILITY_RULE_ID}`;
  const r = await getJSON(url, {
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  }).catch(e=>{ toast(e.message,'err'); return null; });
  if(r){
    toast('Правило видимости обновлено','ok');
    await refreshVisibilityList();
    await selectVisibilityRule(r.id);
  }
};

$('#btnResetVisibilityRule').onclick = ()=>{ resetVisibilityBuilder(); };

$('#tr_src').onchange = async ()=>{
  const stepId = +$('#tr_src').value;
  if(stepId){
    const fields = await refreshTransitionFields(stepId);
    $$('#condList .condition-row').forEach(row=>{
      const fieldSelect = row.querySelector('.c_field');
      if(!fieldSelect) return;
      if(!fields.some(f=>f.code===fieldSelect.value) && fields[0]){
        fieldSelect.value = fields[0].code;
      }
      const field = fields.find(f=>f.code===fieldSelect.value) || null;
      const op = row.querySelector('.c_op')?.value || 'eq';
      updateConditionValueControl(row, 'transition', field, op);
    });
  }
};

async function collectTransitionPayload({useExistingMeta=false}={}){
  const formId = CURRENT_FORM_ID || +$('#formsSelect').value;
  const sourceId = +$('#tr_src').value;
  if(!formId || !sourceId){ toast('Выберите форму и источник перехода','warn'); return null; }
  const targetId = +$('#tr_dst').value;
  if(!targetId){ toast('Выберите целевой шаг','warn'); return null; }
  const fields = await refreshTransitionFields(sourceId);
  if(!fields.length){ toast('В выбранном шаге нет полей для условий','warn'); return null; }
  const rows = $$('#condList .row');
  const conditions = rows.map((r, idx)=>{
    const op = r.querySelector('.c_op').value;
    const fieldCode = r.querySelector('.c_field').value;
    const raw = readConditionControlValue(r, 'transition');
    const field = fields.find(x=>x.code===fieldCode) || {};
    const cond = {field_code:fieldCode, op_code:op, value_text:null, value_num:null, value_bool:null, value_date:null, option_code:null, position:(idx+1)*10};
    Object.assign(cond, resolveConditionValue(field, op, raw));
    return cond;
  });
  const priority = +$('#tr_prio').value || 100;
  const logic = $('#tr_logic').value;
  const description = useExistingMeta && CURRENT_ROUTE_META ? (CURRENT_ROUTE_META.description ?? null) : 'UI transition';
  const scenario = useExistingMeta && CURRENT_ROUTE_META ? CURRENT_ROUTE_META.scenario_description ?? null : null;
  const payload = {
    target_step_id: targetId,
    priority,
    description,
    logic_op: logic,
    conditions,
    scenario_description: scenario
  };
  return {formId, sourceId, payload};
}

$('#btnCreateTransition').onclick = async ()=>{
  const data = await collectTransitionPayload();
  if(!data) return;
  const {formId, sourceId, payload} = data;
  const r = await getJSON(`${API}/admin/forms/${formId}/steps/${sourceId}/routes`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
  }).catch(e=>{ toast(e.message,'err'); return null; });
  if(r){
    toast(`Создан переход #${r.id} (${r.logic_op})`,'ok');
    resetTransitionBuilder();
    await refreshRoutesList();
    await refreshFlowRoutes();
  }
};

$('#btnUpdateTransition').onclick = async ()=>{
  if(!CURRENT_ROUTE_ID){ toast('Выберите переход для редактирования','warn'); return; }
  const data = await collectTransitionPayload({useExistingMeta:true});
  if(!data) return;
  const {formId, payload} = data;
  const r = await getJSON(`${API}/admin/forms/${formId}/routes/${CURRENT_ROUTE_ID}`, {
    method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
  }).catch(e=>{ toast(e.message,'err'); return null; });
  if(r){
    toast(`Переход #${r.id} обновлён`,'ok');
    await refreshRoutesList();
    await refreshFlowRoutes();
    await selectTransition(r.id);
  }
};

$('#btnResetTransition').onclick = ()=>{ resetTransitionBuilder(); };

/* USER runtime */

async function ensureStepIndex(formId){
  if(!formId || FORM_STEP_INDEX[formId]) return;
  const rows = await getJSON(`${API}/admin/forms/${formId}/steps`).catch(()=>[]);
  FORM_STEP_INDEX[formId] = rows.reduce((acc, step)=>{ acc[step.code] = step; return acc; }, {});
}

async function renderNavigation(resp){
  const nav = $('#u_nav'); if(!nav) return;
  await ensureStepIndex(resp.form_id);
  const stepMap = FORM_STEP_INDEX[resp.form_id] || {};
  let html = `<div class="muted">Текущий шаг: ${resp.current_step_code || '—'}</div>`;
  if(resp.completed_steps && resp.completed_steps.length){
    const completedTitles = resp.completed_steps.map(code=>stepMap[code]?.title || code).join(', ');
    html += `<div class="muted">Завершено: ${completedTitles}</div>`;
  }
  if(resp.available_steps && resp.available_steps.length){
    const buttons = resp.available_steps.map(code=>{
      const title = stepMap[code]?.title || code;
      const cls = code === resp.step_code ? 'btn primary' : 'btn ghost';
      return `<button class="${cls}" data-nav-step="${code}">${title}</button>`;
    }).join('');
    html += `<div class="row wrap" style="gap:6px; margin-top:6px;">${buttons}</div>`;
  } else {
    html += '<div class="muted">Нет доступных шагов</div>';
  }
  nav.innerHTML = html;
  nav.querySelectorAll('[data-nav-step]').forEach(btn=>{
    btn.onclick = ()=> jumpToStep(btn.dataset.navStep);
  });
}

async function jumpToStep(stepCode){
  if(!CURRENT_INSTANCE || !CURRENT_FORM_CODE){ toast('Нет активной сессии','warn'); return; }
  const resp = await getJSON(`${API}/runtime/forms/${CURRENT_FORM_CODE}/sessions/${CURRENT_INSTANCE}/steps/${stepCode}`).catch(e=>{
    toast(e.message,'err'); return null;
  });
  if(resp){ await renderStep(resp); }
}

async function renderStep(resp){
  CURRENT_INSTANCE = resp.instance_id;
  if(resp.form_code) CURRENT_FORM_CODE = resp.form_code;
  if(resp.form_id) await ensureStepIndex(resp.form_id);
  $('#u_instance').textContent = CURRENT_INSTANCE ?? '—';
  await renderNavigation(resp);

  const wrap = $('#u_step'); wrap.innerHTML='';
  const container = document.createElement('div');
  container.innerHTML = `<h3 style="margin-bottom:10px">${resp.step_title}</h3>`;
  if(resp.step_code !== resp.current_step_code && !resp.is_terminal){
    container.innerHTML += `<div class="muted">Просмотр шага вне текущей позиции. Измените ответы и сделайте его текущим, чтобы продолжить.</div>`;
  } else if(resp.is_terminal){
    container.innerHTML += `<div class="pill">Финальный шаг</div>`;
  }

  const controls = [];
  resp.fields.forEach(f=>{
    const row = document.createElement('div'); row.className='row'; row.style.marginBottom='8px'; row.dataset.fieldCode = f.code;
    const label = document.createElement('label'); label.style.flex='1 1 100%';
    label.innerHTML = `<span class="muted">${f.title} ${f.is_required?'<span class="badge">обязательно</span>':''}</span>`;
    let ctrl;
    if(f.input_type==='textarea'){
      ctrl = document.createElement('textarea');
    } else if(f.input_type==='select'){
      ctrl = document.createElement('select');
      ctrl.appendChild(opt('','— выберите —'));
      (f.options||[]).forEach(o=>ctrl.appendChild(opt(o.value_code,o.value_label)));
    } else if(f.input_type==='multiselect'){
      ctrl = document.createElement('select'); ctrl.multiple = true; ctrl.size= Math.min(6, (f.options||[]).length||3);
      (f.options||[]).forEach(o=>ctrl.appendChild(opt(o.value_code,o.value_label)));
    } else if(f.input_type==='checkbox'){
      ctrl = document.createElement('input'); ctrl.type='checkbox';
    } else if(f.input_type==='datepicker'){
      ctrl = document.createElement('input'); ctrl.type='date';
    } else {
      ctrl = document.createElement('input'); ctrl.type='text';
    }
    ctrl.dataset.code = f.code;
    const existing = (resp.values||{})[f.code];
    if(existing!==undefined && existing!==null){
      if(ctrl.tagName==='SELECT' && !ctrl.multiple){ ctrl.value = existing; }
      else if(ctrl.tagName==='SELECT' && ctrl.multiple){
        (Array.isArray(existing)?existing:[]).forEach(val=>{
          const optEl = Array.from(ctrl.options).find(o=>o.value==val); if(optEl) optEl.selected = true;
        });
      }
      else if(ctrl.type==='checkbox'){ ctrl.checked = !!existing; }
      else ctrl.value = existing;
    }
    label.appendChild(ctrl); row.appendChild(label); container.appendChild(row);
    row.style.display = f.is_visible ? '' : 'none';
    controls.push({field:f, control:ctrl, row});
  });

  const visibilityConfig = resp.visibility || null;
  const baseDefaults = {};
  controls.forEach(({field, row})=>{
    baseDefaults[field.code] = !field.default_hidden;
    if(!visibilityConfig && field.default_hidden){
      row.style.display = 'none';
    }
  });
  const sortedRules = visibilityConfig ? [...visibilityConfig.rules].sort((a,b)=> (a.priority - b.priority) || (a.id - b.id)) : [];

  const isEmptyValue = val => val === null || val === undefined || (typeof val === 'string' && val.trim()==='') || (Array.isArray(val) && val.length===0);
  const toNumber = val => {
    if(val === null || val === undefined || val === '') return null;
    if(typeof val === 'number') return val;
    const num = Number(val);
    return Number.isNaN(num) ? null : num;
  };
  const listFrom = val => {
    if(Array.isArray(val)) return val.map(v=>String(v));
    if(val === null || val === undefined || val === '') return [];
    return String(val).split(',').map(s=>s.trim()).filter(Boolean);
  };
  const matchesLike = (actual, pattern, insensitive=false)=>{
    const source = actual === null || actual === undefined ? '' : String(actual);
    const rawPattern = pattern === null || pattern === undefined ? '' : String(pattern);
    const escaped = rawPattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp('^' + escaped.replace(/%/g, '.*') + '$', insensitive?'i':'');
    return regex.test(source);
  };
  const compareEquality = (actual, expected)=>{
    if(Array.isArray(actual)){
      if(expected === null || expected === undefined) return actual.length === 0;
      if(Array.isArray(expected)){
        const expectedStrings = expected.map(v=>String(v));
        const actualStrings = actual.map(v=>String(v));
        return expectedStrings.every(val=>actualStrings.includes(val));
      }
      return actual.map(v=>String(v)).includes(String(expected));
    }
    if(Array.isArray(expected)){
      return expected.map(v=>String(v)).includes(String(actual));
    }
    if(typeof expected === 'boolean') return !!actual === expected;
    if(actual === null || actual === undefined) return expected === null || expected === undefined || expected === '';
    if(expected === null || expected === undefined) return actual === null || actual === undefined || actual === '';
    const actualNum = toNumber(actual);
    const expectedNum = toNumber(expected);
    if(actualNum !== null && expectedNum !== null){
      return actualNum === expectedNum;
    }
    return String(actual) === String(expected);
  };
  const listIncludes = (actual, expected)=>{
    const actualList = listFrom(actual);
    const expectedList = listFrom(expected);
    if(!expectedList.length) return false;
    return expectedList.some(val=>actualList.includes(val));
  };

  function readControlValue(field, control){
    if(control.tagName==='SELECT' && control.multiple){
      return Array.from(control.selectedOptions).map(o=>o.value);
    }
    if(control.type==='checkbox'){
      return control.checked;
    }
    if(control.tagName==='SELECT'){
      return control.value === '' ? null : control.value;
    }
    const raw = control.value ?? '';
    if(field.data_type_code==='integer' || field.data_type_code==='decimal'){
      const trimmed = raw.trim();
      if(trimmed==='') return null;
      const num = Number(trimmed);
      return Number.isNaN(num) ? trimmed : num;
    }
    if(field.data_type_code==='boolean'){
      if(raw==='') return null;
      if(typeof raw === 'string'){
        if(raw.toLowerCase()==='true') return true;
        if(raw.toLowerCase()==='false') return false;
      }
      return raw;
    }
    if(field.data_type_code==='date' || field.data_type_code==='datetime'){
      return raw || null;
    }
    return raw === '' ? null : raw;
  }

  function evaluateCondition(cond, values){
    const actual = values[cond.field_code];
    let expected;
    if(cond.rhs_field_code){
      expected = values[cond.rhs_field_code];
    } else if(cond.value_bool !== null && cond.value_bool !== undefined){
      expected = cond.value_bool;
    } else if(cond.value_num !== null && cond.value_num !== undefined){
      expected = cond.value_num;
    } else if(cond.value_date){
      expected = cond.value_date;
    } else if(cond.option_code){
      expected = cond.option_code;
    } else if(cond.value_text){
      expected = cond.value_text;
    } else {
      expected = null;
    }

    switch(cond.op_code){
      case 'is_true': return !!actual === true;
      case 'is_false': return !!actual === false;
      case 'is_empty': return isEmptyValue(actual);
      case 'not_empty': return !isEmptyValue(actual);
      case 'eq': return compareEquality(actual, expected);
      case 'ne': return !compareEquality(actual, expected);
      case 'gt': {
        const aNum = toNumber(actual); const eNum = toNumber(expected);
        return aNum !== null && eNum !== null && aNum > eNum;
      }
      case 'gte': {
        const aNum = toNumber(actual); const eNum = toNumber(expected);
        return aNum !== null && eNum !== null && aNum >= eNum;
      }
      case 'lt': {
        const aNum = toNumber(actual); const eNum = toNumber(expected);
        return aNum !== null && eNum !== null && aNum < eNum;
      }
      case 'lte': {
        const aNum = toNumber(actual); const eNum = toNumber(expected);
        return aNum !== null && eNum !== null && aNum <= eNum;
      }
      case 'in':
        return listIncludes(actual, expected);
      case 'not_in':
        return !listIncludes(actual, expected);
      case 'like':
        return matchesLike(actual, expected, false);
      case 'ilike':
        return matchesLike(actual, expected, true);
      default:
        return compareEquality(actual, expected);
    }
  }

  function evaluateRule(rule, values){
    if(!rule.conditions || !rule.conditions.length) return true;
    const results = rule.conditions.map(cond=>evaluateCondition(cond, values));
    return rule.logic_op === 'OR' ? results.some(Boolean) : results.every(Boolean);
  }

  function computeVisibility(values){
    const state = {...baseDefaults};
    if(visibilityConfig && visibilityConfig.defaults){
      Object.assign(state, visibilityConfig.defaults);
    }
    if(visibilityConfig){
      sortedRules.forEach(rule=>{
        if(evaluateRule(rule, values)){
          rule.targets.forEach(target=>{
            if(rule.action_code==='show') state[target.field_code] = true;
            else if(rule.action_code==='hide') state[target.field_code] = false;
          });
        }
      });
    }
    return state;
  }

  function applyVisibility(initial=false){
    const valueMap = visibilityConfig ? {...visibilityConfig.context_values} : {};
    controls.forEach(({field, control})=>{
      valueMap[field.code] = readControlValue(field, control);
    });
    const state = computeVisibility(valueMap);
    if(initial && visibilityConfig && visibilityConfig.current){
      Object.entries(visibilityConfig.current).forEach(([code, val])=>{
        if(!(code in state)) state[code] = val;
      });
    }
    controls.forEach(({field, row})=>{
      const visible = state[field.code];
      row.style.display = visible ? '' : 'none';
    });
  }

  applyVisibility(true);
  controls.forEach(({control})=>{
    const handler = ()=>applyVisibility(false);
    if(control.tagName==='SELECT'){
      control.addEventListener('change', handler);
    } else if(control.type==='checkbox'){
      control.addEventListener('change', handler);
    } else {
      control.addEventListener('input', handler);
      control.addEventListener('change', handler);
    }
  });

  const collectAnswers = ()=>controls.map(({field, control})=>({
    field_code: field.code,
    value: readControlValue(field, control)
  }));

  const actions = document.createElement('div'); actions.className='row wrap'; actions.style.gap='8px'; actions.style.marginTop='12px';

  if(resp.fields.length){
    const saveBtn = document.createElement('button'); saveBtn.className='btn ghost'; saveBtn.textContent='Сохранить';
    saveBtn.onclick = async ()=>{
      const answers = collectAnswers();
      const updated = await getJSON(`${API}/runtime/forms/${resp.form_code}/sessions/${resp.instance_id}/steps/${resp.step_code}`, {
        method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({answers})
      }).catch(e=>{toast(e.message,'err'); return null;});
      if(updated){ toast('Ответы сохранены','ok'); await renderStep(updated); }
    };
    actions.appendChild(saveBtn);
  }

  if(resp.step_code === resp.current_step_code && !resp.is_terminal){
    const nextBtn = document.createElement('button'); nextBtn.className='btn ok'; nextBtn.textContent='Далее';
    nextBtn.onclick = async ()=>{
      const answers = collectAnswers();
      const res = await getJSON(`${API}/instance/${resp.instance_id}/submit`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({answers})
      }).catch(e=>{toast(e.message,'err'); return null;});
      if(res){
        if(res.is_complete){
          toast('Анкета завершена','ok');
          wrap.innerHTML = '<div class="pill">Анкета завершена</div>';
          await renderNavigation({
            form_id: resp.form_id,
            completed_steps: res.completed_steps,
            available_steps: res.available_steps,
            current_step_code: null,
            step_code: resp.step_code
          });
        } else {
          const next = await getJSON(`${API}/instance/${resp.instance_id}`).catch(e=>{toast(e.message,'err'); return null;});
          if(next) await renderStep(next);
        }
      }
    };
    actions.appendChild(nextBtn);
  }

  if(resp.step_code !== resp.current_step_code && !resp.is_terminal){
    const makeBtn = document.createElement('button'); makeBtn.className='btn primary'; makeBtn.textContent='Сделать текущим';
    makeBtn.onclick = async ()=>{
      const updated = await getJSON(`${API}/runtime/forms/${resp.form_code}/sessions/${resp.instance_id}/set-current/${resp.step_code}`, {method:'POST'}).catch(e=>{toast(e.message,'err'); return null;});
      if(updated){ toast('Шаг стал текущим','ok'); await renderStep(updated); }
    };
    actions.appendChild(makeBtn);
  }

  if(actions.children.length){
    container.appendChild(actions);
  }

  wrap.appendChild(container);
}

$('#btnStart').onclick = async ()=>{
  const userId = +$('#u_user').value; const formId = +$('#u_form').value;
  const form = cache.forms.find(f=>f.id===formId);
  if(form){ CURRENT_FORM_CODE = form.code; CURRENT_FORM_ID = form.id; }
  const r = await getJSON(`${API}/start`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_id:userId, form_id:formId})}).catch(e=>toast(e.message,'err'));
  if(r){ await renderStep(r); }
};

/* boot */
(async function boot(){
  await refreshRefs();
  await refreshForms();
  await refreshDicts();
  await refreshTransitionFields();
  await resetVisibilityBuilder();
  // defaults
  addDictValueRow();
})();
</script>
</body>
</html>
